name: Pantheon CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  # --- JOB 1: REAL GPU COMPILATION CHECK ---
  # Verifies that code is valid CUDA syntax using the official NVIDIA container.
  # This catches GPU-specific syntax errors (like __shfl_sync) that GCC misses.
  cuda-build-check:
    runs-on: ubuntu-latest
    container: nvidia/cuda:12.3.1-devel-ubuntu22.04
    steps:
      - uses: actions/checkout@v3

      - name: Install Build Tools
        run: apt-get update && apt-get install -y build-essential python3

      - name: Compile (CUDA Mode)
        # The Makefile detects NVCC and compiles for a real GPU target
        run: make PLATFORM=CUDA

  # --- JOB 2: CPU LOGIC SIMULATION ---
  # Compiles with G++ (Mock Mode) and runs the Python harness.
  # This verifies:
  # 1. The Python script works (pantheon.py).
  # 2. The Kernels don't crash (Segfaults).
  # 3. No memory leaks (via your new MockLeakDetector).
  cpu-mock-test:
    runs-on: ubuntu-latest
    env:
      PANTHEON_MOCK: "1"  # Tells pantheon.py to allow running without a GPU
    steps:
      - uses: actions/checkout@v3

      - name: Install Python Dependencies
        run: pip3 install psutil pandas openpyxl numpy

      - name: Compile (Mock Mode)
        # Uses the Makefile to compile all .cpp files using g++
        run: make PLATFORM=MOCK

      - name: Run Full Test Suite (Simulation)
        # Runs EVERY test for 2 seconds to ensure stability
        run: python3 pantheon.py --test all --duration 2
